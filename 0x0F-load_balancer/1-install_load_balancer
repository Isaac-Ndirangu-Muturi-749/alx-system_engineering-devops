#!/usr/bin/env bash
# Installs and sets up HAProxy

set -euo pipefail

# Update package repositories
sudo apt-get update

# Install HAProxy
sudo apt-get install -y haproxy

# Enable HAProxy to be started by init script
echo "ENABLED=1" | sudo dd status=none of=/etc/default/haproxy

# Create a backup of the original haproxy.cfg file
sudo mv /etc/haproxy/haproxy.cfg{,.original}

# Define server configuration
DOMAIN="inm-749.tech"
SERVER_CONFIG="
defaults
    mode http
    timeout client 15s
    timeout connect 10s
    timeout server 15s
    timeout http-request 10s

frontend $DOMAIN-frontend
    bind *:80
    default_backend $DOMAIN-backend

backend $DOMAIN-backend
    balance roundrobin
    server 339243-web-01 35.153.193.23:80 check
    server 339243-web-02 54.146.94.67:80 check
"

# Apply server configuration
echo "$SERVER_CONFIG" | sudo dd status=none of=/etc/haproxy/haproxy.cfg

# Restart or start HAProxy service
if [ "$(pgrep -c haproxy)" -le 0 ]; then
	sudo service haproxy start
else
	sudo service haproxy restart
fi
