#!/usr/bin/env bash
# Installs and sets up HAProxy

set -euo pipefail

# Update package repositories
sudo apt-get update

# Install HAProxy
sudo apt-get install -y haproxy

# Create a backup
sudo mv /etc/default/haproxy{,.original}
# Enable HAProxy to be started by init script
echo "ENABLED=1" | sudo tee -a /etc/default/haproxy >/dev/null

# Create a backup of the original haproxy.cfg file
sudo mv /etc/haproxy/haproxy.cfg{,.original}

# Define server configuration
DOMAIN="inm-749.tech"
SERVER_CONFIG="
frontend $DOMAIN-frontend
    bind *:80
    default_backend $DOMAIN-backend

backend $DOMAIN-backend
    balance roundrobin
    server 339243-web-01 35.153.193.23:80 check
    server 339243-web-02 54.146.94.67:80 check
"

# Apply server configuration
echo "$SERVER_CONFIG" | sudo tee -a /etc/haproxy/haproxy.cfg >/dev/null

# Restart or start HAProxy service
if [ "$(pgrep -c haproxy)" -le 0 ]; then
	sudo service haproxy start
else
	sudo service haproxy restart
fi
